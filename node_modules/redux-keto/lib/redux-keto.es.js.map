{"version":3,"file":"redux-keto.es.js","sources":["../src/wrapper.js","../src/buildReducer.js","../src/filterReducer.js","../src/mapReducer.js","../src/memoizeReducer.js"],"sourcesContent":["// Special property that only our wrappers will have:\nconst wrapperMagic = 'redux-keto wrapper'\n\n/**\n * Makes a collection of lazy getters for a key-value state slice.\n * The actual wrapper object inherits from this prototype.\n */\nexport function makeWrapperProto (keys, makeReducer, makeProps) {\n  const wrapperProto = Object.create(null)\n  for (const key of keys) {\n    const reducer = makeReducer(key)\n\n    Object.defineProperty(wrapperProto, key, {\n      configurable: true,\n      enumerable: true,\n      get () {\n        const wrapper = this\n        const stash = wrapper[wrapperMagic]\n\n        // If we are already running, this is a problem!\n        if (stash.running[key]) {\n          const e = new ReferenceError(\n            `Reducer '${key}' depends on its own result`\n          )\n          e.name = 'ReduxKetoCircularReferenceError'\n          throw e\n        }\n        stash.running[key] = true\n\n        // Evaluate the reducer:\n        try {\n          const out = reducer(\n            stash.state[key],\n            stash.action,\n            makeProps(stash.props, wrapper, key),\n            makeProps(stash.oldProps, stash.state, key)\n          )\n          if (out === undefined) {\n            throw new TypeError(`Reducer '${key}' returned undefined`)\n          }\n          Object.defineProperty(wrapper, key, {\n            configurable: true,\n            enumerable: true,\n            writable: false,\n            value: out\n          })\n          return out\n        } finally {\n          stash.running[key] = false\n        }\n      }\n    })\n  }\n\n  return wrapperProto\n}\n\n/**\n * Makes a lazy wrapper object for a key-value state slice.\n */\nexport function makeWrapper (wrapperProto, state, action, props, oldProps) {\n  const wrapper = Object.create(wrapperProto)\n  Object.defineProperty(wrapper, wrapperMagic, {\n    configurable: true,\n    enumerable: false,\n    writable: false,\n    value: { state, action, props, oldProps, running: {} }\n  })\n\n  return wrapper\n}\n\n/**\n * Flattens a lazy key-value wrapper into a plain-old object\n * with the current state as its properties.\n */\nexport function flattenWrapper (state = {}, wrapper) {\n  // If it's not a wrapper, we are done:\n  if (wrapper === null || wrapper[wrapperMagic] == null) return wrapper\n\n  // Diff the old and new states:\n  const keys = Object.keys(Object.getPrototypeOf(wrapper))\n  let unchanged = Object.keys(state).length === keys.length\n  for (const key of keys) {\n    Object.defineProperty(wrapper, key, {\n      configurable: false,\n      enumerable: true,\n      writable: false,\n      value: flattenWrapper(state[key], wrapper[key])\n    })\n    if (wrapper[key] !== state[key]) {\n      unchanged = false\n    }\n  }\n\n  // If nothing changed, just return the previous state:\n  if (unchanged) return state\n\n  delete wrapper[wrapperMagic]\n  return wrapper\n}\n","import { flattenWrapper, makeWrapper, makeWrapperProto } from './wrapper.js'\n\nfunction makePropsDefault (props, peers, id) {\n  return props != null ? props : peers\n}\n\n/**\n * Combines several reducers into one.\n */\nexport function buildReducer (reducerMap, makeProps = makePropsDefault) {\n  // Validate argument types:\n  if (typeof reducerMap !== 'object' || reducerMap === null) {\n    throw new TypeError('The reducer map must be an object.')\n  }\n  const keys = Object.keys(reducerMap)\n  for (const key of keys) {\n    if (typeof reducerMap[key] !== 'function') {\n      throw new TypeError('Reducers must be functions.')\n    }\n  }\n\n  // Build the wrapper:\n  const wrapperProto = makeWrapperProto(keys, key => reducerMap[key], makeProps)\n\n  // Build the default state:\n  const defaultState = {}\n  for (const key of keys) {\n    defaultState[key] = reducerMap[key].defaultState\n  }\n\n  function builtReducer (state = defaultState, action, props, oldProps) {\n    const wrapper = makeWrapper(wrapperProto, state, action, props, oldProps)\n\n    // If we are the topmost fat reducer, flatten the wrappers:\n    return props == null ? flattenWrapper(state, wrapper) : wrapper\n  }\n  builtReducer.defaultState = defaultState\n\n  return builtReducer\n}\n","import { flattenWrapper } from './wrapper.js'\n\nfunction filterActionsDefault (action, props) {\n  return action\n}\n\nfunction filterPropsDefault (props) {\n  return props\n}\n\n/**\n * Filters the props and actions going into a fat reducer.\n */\nexport function filterReducer (\n  reducer,\n  filterAction = filterActionsDefault,\n  filterProps = filterPropsDefault\n) {\n  const defaultState = reducer.defaultState\n\n  function filteredReducer (state = defaultState, action, props, oldProps) {\n    const innerAction = filterAction(action, props)\n    const innerProps = filterProps(props)\n    const innerOldProps = filterProps(oldProps)\n\n    if (!innerAction) return state\n\n    const wrapper = reducer(state, innerAction, innerProps, innerOldProps)\n\n    // If we are the topmost fat reducer, flatten the wrappers:\n    return props == null ? flattenWrapper(state, wrapper) : wrapper\n  }\n  filteredReducer.defaultState = defaultState\n\n  return filteredReducer\n}\n","import { flattenWrapper, makeWrapper, makeWrapperProto } from './wrapper.js'\n\nfunction makePropsDefault (props, peers, id) {\n  return { peers, id }\n}\n\nconst defaultState = {}\n\n/**\n * Applies a reducer to each item of a list.\n * Each reducer manages its own state slice on behalf of the list item.\n */\nexport function mapReducer (reducer, listIds, makeProps = makePropsDefault) {\n  function mapReducer (state = defaultState, action, props, oldProps) {\n    const ids = listIds(props)\n\n    // Try to recycle our wrapper prototype, if possible:\n    const wrapperProto =\n      state === defaultState || ids !== listIds(oldProps)\n        ? makeWrapperProto(ids, id => reducer, makeProps)\n        : Object.getPrototypeOf(state)\n\n    const wrapper = makeWrapper(wrapperProto, state, action, props, oldProps)\n\n    // If we are the topmost fat reducer, flatten the wrappers:\n    return props == null ? flattenWrapper(state, wrapper) : wrapper\n  }\n  mapReducer.defaultState = defaultState\n\n  return mapReducer\n}\n","/**\n * Creates a memoized reducer for derived values.\n * The first aguments are argument filters,\n * which take the props and return an argument to pass to the derivation.\n * The reducer will only run if some of its arguments are not equal ('===').\n */\nexport function memoizeReducer () {\n  let i = arguments.length - 1\n  const reducer = arguments[i]\n  const filters = []\n  while (i-- > 0) filters[i] = arguments[i]\n\n  // Type-check the arguments:\n  if (typeof reducer !== 'function') {\n    throw new TypeError('The reducer must be a function')\n  }\n  for (const filter of filters) {\n    if (typeof filter !== 'function') {\n      throw new TypeError('Each argument filter must be a function')\n    }\n  }\n\n  return function memoizedReducer (\n    state = reducer.defaultState,\n    action,\n    props,\n    oldProps\n  ) {\n    let clean = true\n    const args = []\n    for (let i = 0; i < filters.length; ++i) {\n      args[i] = filters[i](props)\n      if (clean && args[i] !== filters[i](oldProps)) clean = false\n    }\n\n    return clean ? state : reducer(...args)\n  }\n}\n"],"names":["const","let","key","makePropsDefault","arguments"],"mappings":"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"}